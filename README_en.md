# RPMT_reader

<a href="README.md">日本語 README</a>

`RPMT_reader` converts `.edr` files obtained from **neunet** using **RPMT** into event data containing position and time information, and outputs them as CSV files.  
It also provides functions to apply rectangular or circular ROIs to the position data and/or time range.

This package can be used as a **Python library**, allowing direct integration into Python scripts.

tips: The `.edr` files contain the following information:
- Pulse height data of detector signals  
- Identification of whether the signal is from the vertical or horizontal detector  
- Time elapsed since the kicker pulse

---

## Installation & Getting Started

0. Install **Python** and **git**.
1. Move to the directory where you want to place `RPMT_reader`:
   ```
   cd {your_folder}
   ```
2. Clone the repository:
   ```
   git clone https://github.com/carbon12-ryu/RPMT_reader.git
   ```
3. Install the package in editable mode:
   ```
   pip install -e ./RPMT_reader
   ```

Alternatively, you can install it as:
```
pip install ./RPMT_reader
```
However, with this method, **local edits to the source code will not be reflected**.

---

## Usage

1. After installation, import the module in your Python script:
   ```python
   import RPMTreader
   ```
2. Call the functions as needed, e.g.:
   ```python
   RPMTreader.EDRread()
   ```

Sample code is available here: https://github.com/carbon12-ryu/RPMT_reader_sampleCode

---

## Function Reference

### `EDRread`
```python
EDRread(filePath, mapGraphPath, tofGraphPath, eventCsvPath, tofCsvPath, xSwap, ySwap, xySwap, tofBinTime)
```

Reads an `.edr` file, interprets the pulse-height data as neutron events, and optionally outputs 2D maps and TOF spectra.

#### Parameters

| Name | Type | Default | Description |
|------|------|----------|-------------|
| `filePath` | `str` | — | Full path to the `.edr` file. |
| `mapGraphPath` | `str`, optional | `None` | Path to save the 2D neutron event distribution image. Supported formats are those compatible with `matplotlib.savefig` (e.g., `.png`, `.pdf`, `.jpeg`). No output if `None`. |
| `tofGraphPath` | `str`, optional | `None` | Path to save the TOF spectrum plot. Behaves the same as `mapGraphPath`. |
| `eventCsvPath` | `str`, optional | `None` | Path to save the event data as a CSV file. Must end with `.csv`. Not saved if `None`. |
| `tofCsvPath` | `str`, optional | `None` | Path to save TOF data as a CSV file. Must end with `.csv`. Not saved if `None`. |
| `xSwap` | `bool`, optional | `False` | Flip the X-axis if `True`. |
| `ySwap` | `bool`, optional | `False` | Flip the Y-axis if `True`. |
| `xySwap` | `bool`, optional | `False` | Swap X and Y axes if `True`. |
| `tofBinTime` | `float`, optional | `1e-5` | TOF spectrum bin width [seconds] (default: 10 µs). |

#### Returns

| Name | Type | Description |
|------|------|-------------|
| `t0_pulse` | `int` | Number of kicker pulses contained in the `.edr` file. |
| `neutrons` | `numpy.ndarray` | Array of neutron events. Each row is `[x, y, t]` representing position and arrival time. Shape `(N, 3)`. |
| `tof_data` | `numpy.ndarray` | TOF histogram array `[time, count]`. Shape `(N, 2)`. |
| `total_count` | `int` | Total neutron count. |

#### Event CSV Format
```
total KP 
5116
x,y,time[s]
0.506711,0.450617,0.044244
```

#### TOF CSV Format
```
total KP 
5116
bin time[s]
0.0001
time[s],counts
0.000060,12.000000
```

#### Advanced Configuration

The `.edr` file contains pulse-height data, which is converted to neutron counts using parameters defined in:
```
./RPMTreader/settings/EDRsettings.json
```
Normally, these parameters do not need modification.  
If changed, **do not push them to the remote repository**.

| Name | Default | Description |
|------|----------|-------------|
| `clockFreq` | 40e6 | Clock frequency of the neunet system. |
| `effectiveTime` | 400e-9 | Time window [s] within which signals from vertical and horizontal detectors are considered simultaneous (i.e., a valid neutron event). |
| `PL_min` | 128 | Minimum allowed left-side pulse height (below this is treated as noise). |
| `PL_max` | 1024 | Maximum allowed left-side pulse height (above this is treated as noise). |
| `PR_min` | 128 | Minimum allowed right-side pulse height. |
| `PR_max` | 1024 | Maximum allowed right-side pulse height. |

---

### `rectROI`
```python
rectROI(eventCsvPath, xmin, xmax, ymin, ymax, mapGraphPath, tofGraphPath, tofCsvPath, timeROImin, timeROImax, tofBinTime)
```

Applies a **rectangular ROI** to the position data and optionally filters by TOF range.  
Reads event CSVs generated by `EDRread`.

#### Parameters

| Name | Type | Default | Description |
|------|------|----------|-------------|
| `eventCsvPath` | `str` | — | Path to the event CSV file (output from `EDRread`). |
| `xmin` | `float` | — | Minimum X value of ROI. |
| `xmax` | `float` | — | Maximum X value of ROI. |
| `ymin` | `float` | — | Minimum Y value of ROI. |
| `ymax` | `float` | — | Maximum Y value of ROI. |
| `mapGraphPath` | `str`, optional | `None` | Path to save the ROI map image. Displays the selected region. |
| `tofGraphPath` | `str`, optional | `None` | Path to save TOF spectrum of extracted events. |
| `tofCsvPath` | `str`, optional | `None` | Path to save TOF data CSV. |
| `timeROImin` | `float`, optional | `None` | Lower limit of TOF range [s]. |
| `timeROImax` | `float`, optional | `None` | Upper limit of TOF range [s]. Required if `timeROImin` is set. |
| `tofBinTime` | `float`, optional | `10e-6` | TOF bin width [s] (default: 10 µs). |

#### Returns

| Name | Type | Description |
|------|------|-------------|
| `t0_pulse` | `int` | Number of kicker pulses recorded in the event CSV. |
| `neutrons` | `numpy.ndarray` | Extracted neutron events. |
| `tof_data` | `numpy.ndarray` | Extracted TOF data. |
| `total_count` | `int` | Number of extracted neutrons. |

---

### `circleROI`
```python
circleROI(eventCsvPath, xcenter, ycenter, radius, mapGraphPath, tofGraphPath, tofCsvPath, timeROImin, timeROImax, tofBinTime)
```

Applies a **circular ROI** to the position data and optionally filters by TOF range.  
Reads event CSVs generated by `EDRread`.

#### Parameters

| Name | Type | Default | Description |
|------|------|----------|-------------|
| `eventCsvPath` | `str` | — | Path to the event CSV file (output from `EDRread`). |
| `xcenter` | `float` | — | X coordinate of the ROI center. |
| `ycenter` | `float` | — | Y coordinate of the ROI center. |
| `radius` | `float` | — | ROI radius. |
| `mapGraphPath` | `str`, optional | `None` | Path to save the ROI map image (displays selected circle). |
| `tofGraphPath` | `str`, optional | `None` | Path to save TOF spectrum of extracted events. |
| `tofCsvPath` | `str`, optional | `None` | Path to save TOF data CSV. |
| `timeROImin` | `float`, optional | `None` | Lower limit of TOF range [s]. |
| `timeROImax` | `float`, optional | `None` | Upper limit of TOF range [s]. Required if `timeROImin` is set. |
| `tofBinTime` | `float`, optional | `10e-6` | TOF bin width [s] (default: 10 µs). |

#### Returns

| Name | Type | Description |
|------|------|-------------|
| `t0_pulse` | `int` | Number of kicker pulses recorded in the event CSV. |
| `neutrons` | `numpy.ndarray` | Extracted neutron events. |
| `tof_data` | `numpy.ndarray` | Extracted TOF data. |
| `total_count` | `int` | Number of extracted neutrons. |

---

## Developer
Ryuto Fujitani

## Development
Please fork the repository and create a pull request to the main branch.  
For bug reports or feature requests, please open an issue.
